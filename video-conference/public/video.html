<!DOCTYPE html>
<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <!-- This adapter.js file de-prefixes the webkit* and moz* prefixed RTC
             methods. When RTC becomes a more solid standard, this adapter should no
             longer be necessary. -->
    <!-- <script src="https://webrtc.googlecode.com/svn/trunk/samples/js/base/adapter.js"></script> -->
    <style>
      html,
      body {
        background-color: transparent;
        background: none transparent;
      }
      .participents {
        display: flex;
        flex-wrap: wrap;
      }
      video {
        border: 1px solid black;
        transform: rotateY(180deg);
        -webkit-transform: rotateY(180deg); /* Safari and Chrome */
        -moz-transform: rotateY(180deg); /* Firefox */
        border-radius: 16px;
      }
      .container {
        position: relative;
        width: calc(50% - 32px);
        max-width: 300px;
        aspect-ratio: 1 / 1;
        margin: 16px;
      }
    </style>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script>
      let roomId = 0;
      let userId = '';
      let videoServerWebsocket = '';
      let audioServerWebsocket = '';
      let screenServerWebsocket = '';
      window.isScreenEnable = false
      window.isWebcamEnable = false
      window.screenEl = undefined
      window.webcamEl = undefined
      window.peer_owners_dict = {}
      window.peer_media_subelements = {}
      window.peer_media_availability = {}
      window.peer_media_elements = {}
      window.peer_media_streams = {}
      window.openCallPage = () => {
        document.getElementById('openContainer').style.display = 'none';
        window.initVideo(
          userId,
          roomId,
          videoServerWebsocket,
        );
        window.initAudio(
          userId,
          roomId,
          audioServerWebsocket,
        );
        window.initScreen(
          userId,
          roomId,
          screenServerWebsocket,
        );
      }
      window.updateVideoScreen = (userId) => {
        if (window.peer_media_availability['video-' + userId] === true) {
          if (window.peer_media_availability['screen-' + userId] === true) {
            window.peer_media_subelements['video-' + userId].style.width = '25%'
          } else {
            window.peer_media_subelements['video-' + userId].style.width =
              '100%'
          }
        }
      }
      let disableMax = function (e) {
        document.getElementById('max').style.display = 'none'
      }
      function setMediaBitrates(sdp) {
        return setMediaBitrate(setMediaBitrate(sdp, 'video', 250), 'audio', 50)
      }
      function setMediaBitrate(sdp, media, bitrate) {
        var lines = sdp.split('\n')
        var line = -1
        for (var i = 0; i < lines.length; i++) {
          if (lines[i].indexOf('m=' + media) === 0) {
            line = i
            break
          }
        }
        if (line === -1) {
          console.debug('Could not find the m line for', media)
          return sdp
        }
        console.debug('Found the m line for', media, 'at line', line)

        // Pass the m line
        line++

        // Skip i and c lines
        while (
          lines[line].indexOf('i=') === 0 ||
          lines[line].indexOf('c=') === 0
        ) {
          line++
        }

        // If we're on a b line, replace it
        if (lines[line].indexOf('b') === 0) {
          console.debug('Replaced b line at line', line)
          lines[line] = 'b=AS:' + bitrate
          return lines.join('\n')
        }

        // Add a new b line
        console.debug('Adding new b line before line', line)
        var newLines = lines.slice(0, line)
        newLines.push('b=AS:' + bitrate)
        newLines = newLines.concat(lines.slice(line, lines.length))
        return newLines.join('\n')
      }
    </script>
    <script src="/js/video.js?v=10"></script>
    <script src="/js/screen.js?v=10"></script>
    <script src="/js/audio.js?v=10"></script>
  </head>
  <body style="width: auto; height: 100vh; display: flex; flex-wrap: wrap;">
    <div
      id="max"
      style="
        display: none;
        width: 100%;
        height: 100%;
        position: relative;
        z-index: 99999;
      "
    >
      <video
        onclick="disableMax()"
        autoplay
        id="screenMax"
        style="
          transform: rotateY(0);
          object-fit: cover;
          position: absolute;
          left: 0px;
          top: 0px;
          width: calc(100% - 200px - 16px);
          height: auto;
        "
      ></video>
      <video
        onclick="disableMax()"
        autoplay
        id="webcamMax"
        style="
          object-fit: cover;
          position: absolute;
          right: 0px;
          top: 0px;
          width: 200px;
          height: 200px;
        "
      ></video>
    </div>
    <div
      id="participents"
      class="participents"
      style="width: 100%; height: auto;"
    >
      <div id="me" class="container" style="display: none;"></div>
    </div>
    <div style="width: 100%; height: 128px;"></div>
    <div id="openContainer" style="width: 100%; height: 100%; position: fixed; left: 0px; top: 0px; z-index: 99999; display: block;">
      <button id="openBtn" style="display: none;" onclick="window.openCallPage()">
        ورود به مکالمه
      </button>
    </div>
  </body>
  <script>
    window.addEventListener('message', (e) => {
      console.log(e.data)
      if (e.data.sender === 'main') {
        if (e.data.action === 'switchVideoFlag') {
          if (e.data.stream === true) {
            window.startVideo()
          } else if (e.data.stream === false) {
            window.endVideo()
          }
        }
        else if (e.data.action === 'switchAudioFlag') {
          if (e.data.stream === true) {
            window.startAudio()
          } else if (e.data.stream === false) {
            window.endAudio()
          }
        } else if (e.data.action === 'switchScreenFlag') {
          if (e.data.stream === true) {
            window.startScreen()
          } else if (e.data.stream === false) {
            window.endScreen()
          }
        } else if (e.data.userId !== undefined && e.data.roomId !== undefined) {
          roomId = e.data.roomId;
          userId = e.data.userId;
          videoServerWebsocket = e.data.videoServerWebsocket;
          audioServerWebsocket = e.data.audioServerWebsocket;
          screenServerWebsocket = e.data.screenServerWebsocket;
          document.getElementById('openBtn').style.display = 'block';
        } else if (e.data.targetId !== undefined) {
          if (e.data.status === true) {
            window.enableVideoUser(e.data.targetId)
          } else if (e.data.status === false) {
            window.disableVideoUser(e.data.targetId)
          }
        }
      }
    })
  </script>
</html>

<!DOCTYPE html>
<html lang="en" style="background-color: transparent;">
  <head>
    <meta charset="UTF-8" />
    <title>wavesurfer-box</title>

    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
  </head>
  <body style="background-color: transparent;">
    <audio style="display: none;" id="sound" src="" controls="controls"></audio>
    <style>
      .btn {
        background-color: DodgerBlue;
        border: none;
        color: white;
        width: 48px;
        height: 48px;
        padding: 12px 16px;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
        cursor: pointer;
        border-radius: 50% 50% 50% 50%;
      }

      /* Darker background on mouse-over */
      .btn:hover {
        background-color: RoyalBlue;
      }
    </style>

    <div style="display: flex; flex-wrap: nowrap; height: 40%;">
      <button id="playPauseButton" onclick="wavesurferToggle()" class="btn">
        <i id="playPauseContent" class="fa fa-play"></i>
      </button>
      <div id="loading_flag">
        <!-- content set by JS  -->			
      </div>
      <div style="width: calc(100% - 56px); margin-left: 56px;">
        <div id="waveform" />
      </div>
    </div>

    <script>

      var mediaElt = document.getElementById('sound');

      let wavesurfer = WaveSurfer.create({
        container: '#waveform',
        backend: 'MediaElement',
        maxCanvasWidth: 40000,
        pixelRatio: 1,
        height: 48,
        barWidth: 2,
        barHeight: 1,
        barGap: null,
      })

      window.wavesurfer = wavesurfer
      window.addEventListener('message', (e) => {
        console.log(e.data)
        if (e.data.sender === 'main') {
          window.wavesurferToggle = () => {
            let playPauseContent = document.getElementById('playPauseContent')
            if (wavesurfer.isPlaying()) {
              wavesurfer.pause()
              playPauseContent.className = 'fa fa-play'
            } else {
              if (!wavesurfer.loaded) {
                $("#sound").attr("src", wavesurfer.song);
                wavesurfer.load(mediaElt, wavesurfer.backend.peaks);
              } else {
                wavesurfer.play();
              }
              playPauseContent.className = 'fa fa-pause';
            }
          }
          if (e.data.previewData === undefined || e.data.previewData === null) {
          let requestOptions = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              token: e.data.token,
            },
            body: JSON.stringify({
              fileId: e.data.fileId,
              roomId: e.data.roomId,
            }),
            redirect: 'follow',
          }
          fetch(
            e.data.serverRoot + '/file/download_audio_preview',
            requestOptions,
          )
            .then((response) => response.json())
            .then((result) => {
              console.log(JSON.stringify(result))
              if (result !== undefined) {
                wavesurfer.song = e.data.src
                wavesurfer.backend.peaks = result.data
                for (let i = 0; i < result.data.length; i++) {
                  result.data[i] = result.data[i] / 100
                }
                wavesurfer.drawBuffer()
                wavesurfer.loaded = false
                wavesurfer.on('ready', function () {
                  if (!wavesurfer.loaded) {
                    wavesurfer.loaded = true
                    wavesurfer.play()
                  }
                })
              }
            })
            .catch((error) => console.log('error', error))
        }
      else {
        wavesurfer.song = e.data.src
                wavesurfer.backend.peaks = e.data.previewData.data
                for (let i = 0; i < e.data.previewData.data.length; i++) {
                  e.data.previewData.data[i] = e.data.previewData.data[i] / 100
                }
                wavesurfer.drawBuffer()
                wavesurfer.loaded = false
                wavesurfer.on('ready', function () {
                  if (!wavesurfer.loaded) {
                    wavesurfer.loaded = true
                    wavesurfer.play()
                  }
                })
      }
      }
      })
    </script>
  </body>
</html>
